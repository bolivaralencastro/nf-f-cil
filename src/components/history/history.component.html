<div class="space-y-6 animate-fade-in">
  <header class="flex justify-between items-start flex-wrap gap-4">
    <div>
      <h1 class="text-3xl font-bold text-teal-400">Histórico de Compras</h1>
      <p class.="text-gray-400 mt-1">Todas as suas notas fiscais, em um só lugar.</p>
    </div>
    <button (click)="showSettings.set(!showSettings())" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0 0 15 0m-15 0a7.5 7.5 0 1 1 15 0m-15 0H3m18 0h-1.5m-15 0a7.5 7.5 0 1 1 15 0m-15 0H3m18 0h-1.5m-15 0a7.5 7.5 0 1 1 15 0m-15 0H3m18 0h-1.5" /></svg>
      <span>Configurações</span>
    </button>
  </header>

  <!-- Connection Error Banner -->
  @if(sheetsService.connectionError(); as errorMsg) {
    <section class="bg-red-800/50 border border-red-600 text-red-300 p-4 rounded-lg flex items-start gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 flex-shrink-0">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
      </svg>
      <div>
        <h3 class="font-bold">Erro de Sincronização</h3>
        <p class="text-sm">{{ errorMsg }}</p>
      </div>
    </section>
  }
  
  <!-- Settings Section -->
  @if(showSettings()) {
    <section class="bg-gray-800 rounded-lg p-4 sm:p-6 shadow-lg border border-gray-700 animate-fade-in">
      <h3 class="text-xl font-semibold text-white">Sincronização com Planilha Google</h3>
      <p class="text-gray-400 mt-1 text-sm">Cole a URL do seu Web App (Google Apps Script) para salvar e carregar seus dados na nuvem.</p>
      
       <div class="flex items-center gap-2 mt-4 text-sm" [class.text-green-400]="sheetsService.isConfigured()" [class.text-yellow-400]="!sheetsService.isConfigured()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              @if(sheetsService.isConfigured()) {
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              } @else {
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              }
          </svg>
          <span>
            @if(sheetsService.isConfigured()) {
              Sincronização ATIVA. Os dados estão sendo salvos na sua planilha.
            } @else {
              Sincronização INATIVA. Os dados estão sendo salvos apenas neste navegador.
            }
          </span>
      </div>

      <form #urlForm="ngForm" (ngSubmit)="onSaveScriptUrl()" class="flex flex-col sm:flex-row gap-2 mt-4">
          <input type="url" 
                 name="scriptUrl" 
                 [ngModel]="scriptUrlInput()"
                 (ngModelChange)="scriptUrlInput.set($event)"
                 required
                 placeholder="https://script.google.com/macros/s/..." 
                 class="flex-grow bg-gray-700 text-white placeholder-gray-500 p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none">
          <button type="submit" 
                  [disabled]="!urlForm.valid || isSyncingAfterSave()"
                  class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            @if(isSyncingAfterSave()) {
              <div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>
              <span>Sincronizando...</span>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M20.995 9.348a10.995 10.995 0 1 1-5.99-10.158M12 2.502V8.877h6.375" /></svg>
              <span>Salvar e Sincronizar</span>
            }
          </button>
      </form>
       @if(saveUrlMessage(); as msg) {
          <p class="text-sm mt-2 animate-fade-in" [class.text-green-400]="!msg.isError" [class.text-red-400]="msg.isError">
            {{ msg.text }}
          </p>
      }
      <div class="mt-6">
        <button (click)="onMigrate()" [disabled]="isMigrating() || !sheetsService.isConfigured()" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2 disabled:bg-gray-700 disabled:cursor-not-allowed disabled:opacity-50">
          @if(isMigrating()) {
              <div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>
              <span>Migrando...</span>
          } @else {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>
              <span>Migrar Itens Antigos</span>
          }
        </button>
        @if(migrationMessage()) {
            <p class="text-xs text-teal-400 mt-2 animate-fade-in">{{ migrationMessage() }}</p>
        }
      </div>

    </section>
  }

  <div class="lg:grid lg:grid-cols-5 lg:gap-8">
    <!-- List Pane -->
    <div class="lg:col-span-2" [class]="selectedReceipt() ? 'hidden lg:block' : 'block'">
      <div class="bg-gray-800 rounded-lg p-4 sm:p-6 shadow-lg border border-gray-700 h-full">
        @if(receiptService.isLoading()) {
          <div class="space-y-3 animate-pulse">
            @for (_ of [1,2,3,4,5]; track $index) {
              <div class="flex justify-between items-center bg-gray-700/50 p-4 rounded-lg h-[76px]">
                <div class="flex-1 min-w-0">
                  <div class="h-5 bg-gray-600 rounded w-3/4"></div>
                  <div class="h-4 bg-gray-600 rounded w-1/2 mt-2"></div>
                </div>
                <div class="flex items-center gap-4 ml-2">
                  <div class="text-right">
                    <div class="h-6 bg-gray-600 rounded w-20"></div>
                    <div class="h-3 bg-gray-600 rounded w-12 mt-1.5 ml-auto"></div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <app-receipt-list 
            [receipts]="receiptService.receipts()" 
            [syncEnabled]="sheetsService.isConfigured()"
            (receiptSelected)="onReceiptSelected($event)"
            (retrySync)="onRetrySync($event)"
            (reprocess)="onReprocessReceipt($event)"
            (urlUpdated)="onReceiptUrlUpdated($event)"
            (delete)="onDeleteRequested($event)"
          />
        }
      </div>
    </div>

    <!-- Details Pane -->
    <div class="lg:col-span-3" [class]="selectedReceipt() ? 'block' : 'hidden lg:block'">
      @if (selectedReceipt(); as receipt) {
        <app-receipt-details 
          [receipt]="receipt" 
          (reset)="resetSelection()"
          (receiptUpdated)="onReceiptUpdated($event)"
        />
      } @else {
        <div class="hidden lg:flex h-full min-h-[400px] items-center justify-center rounded-lg bg-gray-800 border border-gray-700 p-6">
          <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="mt-4 text-lg font-semibold text-gray-400">Selecione uma compra</p>
            <p class="text-sm text-gray-500">Os detalhes aparecerão aqui.</p>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
@if (receiptToDelete(); as receipt) {
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 animate-fade-in">
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 w-full max-w-md text-center">
            <h3 class="text-xl font-bold text-red-400 mb-4">Confirmar Exclusão</h3>
            <p class="text-gray-300 mb-6">
                Você tem certeza que deseja deletar a nota de <br> <span class="font-semibold text-white">{{ receipt.storeName || 'ID: ' + receipt.id }}</span>?
                <br>
                <span class="text-sm text-gray-400">Esta ação não pode ser desfeita.</span>
            </p>
            <div class="flex justify-center gap-4">
                <button (click)="cancelDelete()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">
                    Cancelar
                </button>
                <button (click)="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">
                    Deletar
                </button>
            </div>
        </div>
    </div>
}