<div class="space-y-6 animate-fade-in">
  <header class="flex justify-between items-start flex-wrap gap-4">
    <div>
      <h1 class="text-3xl font-bold text-teal-400">Relatórios e Assistente IA</h1>
      <p class="text-gray-400 mt-1">Analise seus dados e converse com a IA para obter insights.</p>
    </div>
    <button (click)="onBackToHome()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
      </svg>
      <span>Voltar ao Início</span>
    </button>
  </header>

  <!-- Tabs Navigation -->
  <nav class="flex border-b border-gray-700">
    <button (click)="setTab('ai')" 
            class="px-4 py-2 font-semibold transition-colors duration-200"
            [class.border-b-2]="activeTab() === 'ai'"
            [class.border-teal-400]="activeTab() === 'ai'"
            [class.text-teal-400]="activeTab() === 'ai'"
            [class.text-gray-400]="activeTab() !== 'ai'"
            [class.hover:text-white]="activeTab() !== 'ai'">
      Assistente IA
    </button>
    <button (click)="setTab('overview')" 
            class="px-4 py-2 font-semibold transition-colors duration-200"
            [class.border-b-2]="activeTab() === 'overview'"
            [class.border-teal-400]="activeTab() === 'overview'"
            [class.text-teal-400]="activeTab() === 'overview'"
            [class.text-gray-400]="activeTab() !== 'overview'"
            [class.hover:text-white]="activeTab() !== 'overview'">
      Visão Geral
    </button>
    <button (click)="setTab('stores')" 
            class="px-4 py-2 font-semibold transition-colors duration-200"
            [class.border-b-2]="activeTab() === 'stores'"
            [class.border-teal-400]="activeTab() === 'stores'"
            [class.text-teal-400]="activeTab() === 'stores'"
            [class.text-gray-400]="activeTab() !== 'stores'"
            [class.hover:text-white]="activeTab() !== 'stores'">
      Análise por Loja
    </button>
  </nav>

  <!-- Tab Content -->
  <main>
    @if(receiptService.receipts().length === 0) {
      <div class="text-center py-16 bg-gray-800 rounded-lg">
        <h3 class="text-xl font-semibold text-white">Você ainda não tem dados para analisar.</h3>
        <p class="text-gray-400 mt-2">Use o botão central para escanear uma nota fiscal e começar a popular seus dados.</p>
      </div>
    } @else {
      @switch (activeTab()) {
        @case ('ai') {
          <div class="bg-gray-800 rounded-lg p-4 sm:p-6 shadow-lg border border-gray-700 h-full flex flex-col max-h-[70vh]">
            <!-- Chat Messages -->
            <div class="flex-grow overflow-y-auto space-y-4 pr-2">
              @for (message of aiMessages(); track $index) {
                <div class="flex" [class.justify-end]="message.role === 'user'">
                  <div class="p-3 rounded-lg max-w-lg" 
                       [class.bg-teal-800]="message.role === 'user'"
                       [class.bg-gray-700]="message.role === 'model'">
                    <p class="text-white whitespace-pre-wrap">{{ message.content }}</p>
                  </div>
                </div>
              }
              @if (aiIsLoading() && aiMessages()[aiMessages().length - 1].content === '') {
                 <div class="flex justify-start">
                    <div class="p-3 rounded-lg bg-gray-700">
                        <div class="flex items-center gap-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-teal-500"></div>
                            <span class="text-gray-400 text-sm">Pensando...</span>
                        </div>
                    </div>
                </div>
              }
              @if (aiMessages().length === 0) {
                <div class="text-center text-gray-500 pt-8">
                  <p>Olá! Sou seu assistente financeiro.</p>
                  <p>Faça uma pergunta sobre seus gastos ou escolha uma das sugestões abaixo.</p>
                </div>
              }
            </div>

            <!-- Predefined Questions & Input -->
            <div class="mt-4 pt-4 border-t border-gray-700">
               @if (aiMessages().length === 0) {
                <div class="flex flex-wrap gap-2 mb-4">
                  @for(q of predefinedQuestions; track q) {
                    <button (click)="askAi(q)" class="text-sm bg-gray-700 hover:bg-gray-600 text-teal-300 font-medium py-2 px-3 rounded-full transition duration-300">
                      {{q}}
                    </button>
                  }
                </div>
              }

              <form (ngSubmit)="askAi()" class="flex gap-2">
                <input type="text"
                       name="userInput"
                       [(ngModel)]="userInput"
                       placeholder="Pergunte algo sobre seus gastos..."
                       class="flex-grow bg-gray-700 text-white placeholder-gray-500 p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none">
                <button type="submit"
                        [disabled]="!userInput() || aiIsLoading()"
                        class="bg-teal-500 hover:bg-teal-600 text-white font-bold p-3 rounded-lg transition duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                  </svg>
                </button>
              </form>
            </div>
          </div>
        }
        @case ('overview') {
          <div class="text-center py-16 bg-gray-800 rounded-lg">
            <h3 class="text-xl font-semibold text-white">Em breve: Visão Geral</h3>
            <p class="text-gray-400 mt-2">Um dashboard detalhado com filtros de data para analisar seus gastos.</p>
          </div>
        }
        @case ('stores') {
          <div class="text-center py-16 bg-gray-800 rounded-lg">
            <h3 class="text-xl font-semibold text-white">Em breve: Análise por Loja</h3>
            <p class="text-gray-400 mt-2">Compare seus gastos e produtos favoritos em cada estabelecimento.</p>
          </div>
        }
      }
    }
  </main>
</div>
