<div class="space-y-6 animate-fade-in">
  <header>
    <h1 class="text-3xl font-bold text-teal-400">Mapa de Compras</h1>
    <p class="text-gray-400 mt-1">Veja onde você mais compra e analise seus gastos por local.</p>
  </header>

  <div class="lg:grid lg:grid-cols-3 lg:gap-8">
    <!-- Map -->
    <section #map class="w-full h-80 lg:h-[65vh] lg:col-span-2 bg-gray-800 rounded-lg border border-gray-700 z-0"></section>
    
    <!-- Ranking -->
    <section class="lg:col-span-1">
      <h2 class="text-xl font-semibold text-white mb-4">Ranking de Lojas</h2>
      @if (receiptService.isLoading()) {
        <!-- SKELETON LOADER -->
        <ul class="space-y-3 animate-pulse">
          @for (_ of [1,2,3,4]; track $index) {
            <li class="bg-gray-800 p-4 rounded-lg border border-gray-700 h-[78px]">
              <div class="flex justify-between items-start">
                  <div class="min-w-0 flex-1 pr-4">
                      <div class="h-5 bg-gray-700 rounded w-3/4"></div>
                      <div class="h-4 bg-gray-700 rounded w-1/2 mt-2"></div>
                  </div>
                  <div class="text-right flex-shrink-0">
                      <div class="h-6 bg-gray-700 rounded w-20"></div>
                  </div>
              </div>
            </li>
          }
        </ul>
      } @else {
        @if(stores().length > 0) {
          <ul class="space-y-3 max-h-[65vh] overflow-y-auto">
            @for(store of stores(); track store.storeCnpj) {
              <li class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 flex-1 pr-4">
                            <p class="font-bold text-white truncate">{{ store.storeName }}</p>
                            <p class="text-sm text-gray-400">{{ store.receiptCount }} {{ store.receiptCount > 1 ? 'compras' : 'compra' }}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-lg text-teal-300">R$ {{ store.totalSpent.toFixed(2) }}</p>
                            <button (click)="openEditModal(store)" class="text-xs text-teal-400 hover:text-teal-300 transition-colors mt-1">Editar Local</button>
                        </div>
                    </div>
                    @if(store.geocodingStatus === 'error') {
                      <p class="text-xs text-yellow-500 mt-2">Endereço não encontrado. Clique em "Editar Local" para corrigir.</p>
                    }
                </li>
            }
          </ul>
        } @else {
          <div class="text-center py-12 bg-gray-800 rounded-lg h-full flex flex-col justify-center">
            <h3 class="text-xl font-semibold text-white">Nenhum dado de loja encontrado.</h3>
            <p class="text-gray-400 mt-2">Escaneie algumas notas para ver suas lojas no mapa.</p>
          </div>
        }
      }
    </section>
  </div>
</div>

<!-- Modal de Edição de Endereço -->
@if (storeToEdit(); as store) {
  <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 animate-fade-in">
    <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 w-full max-w-lg">
      <h3 class="text-xl font-bold text-teal-400 mb-2">Editar Endereço</h3>
      <p class="text-gray-400 mb-4">Corrija o endereço de <span class="font-semibold text-white">{{ store.storeName }}</span> para melhorar a precisão do mapa.</p>
      
      <form #addressForm="ngForm" (ngSubmit)="saveAddressChange()">
        <textarea name="address" 
                  [(ngModel)]="editedAddress"
                  required
                  rows="3"
                  class="w-full mt-1 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-teal-500 focus:border-teal-500"></textarea>
        
        <div class="flex justify-end gap-4 mt-6">
          <button type="button" (click)="closeEditModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">
            Cancelar
          </button>
          <button type="submit" [disabled]="!addressForm.valid" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed">
            Salvar e Tentar Novamente
          </button>
        </div>
      </form>
    </div>
  </div>
}